#!/usr/bin/env bash

source env/dev-setup-config.env
source bin/setup-ssh-fn

# on n’exécute pas la commande si le projet ne provient pas de github
if ! git rev-parse --is-inside-work-tree > /dev/null 2>&1; then
    echo "Ce projet n'a pas été installé à partir de Git mais transféré à partir des fichiers Windows"
    echo "On ne peut donc pas faire de git pull."
    echo "Vous pouvez refaire une installation from scratch à partir de github avec la commande bin/clonefromgithub"
    exit 1
fi

### bin/setup-ssh-fn - permet d’utiliser les commandes Git sans paramètres ssh
run_ssh_agent_and_register_key "id_ed25519"

DOCKER_SERVICE="phpfpm"
CONTAINER_ID=$(bin/docker-compose ps -q $DOCKER_SERVICE | awk '{print $1}')

TRANSFER_GITHUB_PATH="$TRANSFER_PATH/github"
HOST_SRC=$(cd -P "$TRANSFER_GITHUB_PATH" && pwd)
# on change de dossier courant pour toutes les commandes git qui suivent
cd "$HOST_SRC"

current_branch=$(git branch --show-current)
echo "La branche courante est : $current_branch"

echo -e "Attention \nToutes les modifications de fichiers non commitées sur cette branche seront perdues."
read -p "Souhaitez-vous vraiment continuer ? (oui/non) : " reponse

# Vérifier la réponse de l'utilisateur
if [[ "$reponse" != "oui" ]]; then
    echo "Annulation de la commande."
    exit 1
fi


echo "Delete all files from docker container except /vendor and /pub/media"
docker exec "$CONTAINER_ID" bash -c 'find /var/www/html/* -maxdepth 1 ! -path "/var/www/html/vendor" ! -path "/var/www/html/vendor/*" ! -path "/var/www/html/pub/media" ! -path "/var/www/html/pub/media/*" -exec rm -rf {} +'

echo "Running git reset --hard && git pull"
git reset --hard && git pull

echo "Copy files from Debian host to Docker container"
docker cp "$HOST_SRC/./" "$CONTAINER_ID":/var/www/html/
echo "Completed copying all files"

# on rétablit le chemin pour lancer les commandes bin/*
cd "$COMPOSE_PATH"

# Toutes les commandes à jouer lorsqu'on change les fichiers sources
echo "Exécution de toutes les commandes bin/* qui sont nécessaires après un changement des fichiers sources"
bin/composer install
bin/fixowns
bin/fixperms
bin/clinotty bin/magento setup:upgrade
bin/magento setup:di:compile
echo "Toutes les commandes bin/* ont été exécutées."

