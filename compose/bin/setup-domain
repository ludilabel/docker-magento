#!/usr/bin/env bash
set -o errexit

source env/setup/magento-stores.env

# listes de données dans env/magento-stores.env
# boutiques Magento 2
declare -A store_codes
for entry in ${TLD_STORE_MAP}; do
  store_codes[${entry%%:*}]=${entry##*:}
done

echo "Veuillez saisir le nom de domaine pour accéder aux boutiques Magento 2 localement"
read -r -p "(ex : franz.docker.ludilabel) sans le suffixe du domaine de premier niveau (.fr,...) : " DN

echo "Veuillez coller le chemin Windows complet du fichier host"
read -r -p "(ex : C:\Windows\System32\drivers\etc\hosts) : " WIN_HOST

# Transformation du chemin Windows en chemin Debian WSL2
if [[ "$WIN_HOST" =~ ^[A-Za-z]:\\ ]]; then

    # Remplacer les antislashs par des slashes pour la conversion avec wslpath
    WIN_HOST=$(echo "$WIN_HOST" | sed 's|\\|/|g')

    # Convertir le chemin au format WSL
    WIN_HOST=$(wslpath -a "$WIN_HOST")

    if [ $? -ne 0 ]; then
        echo "Erreur lors de la conversion du chemin."
        exit 1
    fi

    echo "Chemin converti au format Debian WSL2 : $WIN_HOST"
fi

# Vérifier si le fichier existe
if [ ! -f "$WIN_HOST" ]; then
    echo "Le fichier spécifié n'existe pas."
    exit 1
fi

DEBIAN_IP=$(hostname -I | awk '{print $1}')

# Initialize an array to hold entries that need to be added
entries_to_add=()
ALL_FQDN=()

# Loop through each top-level domain and prepare the corresponding entry
for TLD in "${!store_codes[@]}"; do
    # Define the entry for each TLD
    entry="$DEBIAN_IP $DN.$TLD"

    ALL_FQDN+=("$DN.$TLD")

    # Check if the entry already exists in the hosts file
    if ! grep -q "$entry" "$WIN_HOST"; then
        echo "Preparing to add entry $entry to the Windows hosts file..."
        entries_to_add+=("$entry")
    else
        echo "Entry $entry already exists in the hosts file."
    fi
done

# If there are entries to add, run the PowerShell script
if [ ${#entries_to_add[@]} -gt 0 ]; then
    echo "Adding entries to the Windows hosts file..."
    echo "Vous devez fermer provisoirement vos navigateurs web avant de continuer pour éviter un conflit sur le ficher Windows hosts"

    # script is halted until user response
    read -p "Appuyez sur entrée une fois que les navigateurs sont fermés."

    echo "Please accept PowerShell invitation if any"

    # Convert the array to a PowerShell-compatible string
    entries_ps="$(printf "'%s'; " "${entries_to_add[@]}")"

    powershell.exe -Command "
    \$entries = @($entries_ps);
    \$entries | ForEach-Object { Add-Content -Path 'C:\Windows\System32\drivers\etc\hosts' -Value \$_ }
    "
else
    echo "All entries already exist in the hosts file."
fi

echo "Vous pouvez rouvrir vos navigateurs web"

echo "Ajout des noms de domaine pour toutes les boutiques dans core_config_data"
# scope stores
for TLD in "${!store_codes[@]}"; do
  bin/clinotty bin/magento config:set web/unsecure/base_url "https://$DN.$TLD/" --scope=stores --scope-code="${store_codes[$TLD]}" > /dev/null
done

# scope default
bin/clinotty bin/magento config:set web/unsecure/base_url "https://$DN.fr/" --scope=default  > /dev/null


echo "Generating SSL certificates..."
bin/setup-ssl "${ALL_FQDN[@]}"
