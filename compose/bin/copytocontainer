#!/usr/bin/env bash
[ -z "$1" ] && echo "Please specify a path directory (ex: app/etc) or path file (ex: app/etc/env.php)" && exit

source env/dev-setup-config.env

DOCKER_SERVICE="phpfpm"
CONTAINER_ID=$(bin/docker-compose ps -q $DOCKER_SERVICE | awk '{print $1}')

HOST_SRC=$(cd -P "$TRANSFER_PATH" && pwd)

echo "Copy first from Windows to Debian"

if [ -d "$OS_SRC/$1" ]; then
  mkdir -p "$HOST_SRC/windows/$1"
  rsync -az --info=progress2 --delete "$OS_SRC/$1/" "$HOST_SRC/windows/$1/"
else
  mkdir -p "$HOST_SRC/windows/$(dirname "$1")"
  rsync -az --info=progress2 --delete "$OS_SRC/$1" "$HOST_SRC/windows/$1"
fi

echo "Copy from Debian to docker container"
docker exec "$CONTAINER_ID" rm -rf /var/www/html/"$1"
docker exec "$CONTAINER_ID" mkdir -p /var/www/html/"$(dirname "$1")"
docker cp "$HOST_SRC/windows/${1}" "$CONTAINER_ID":/var/www/html/"$1"

echo "Completed copying $1 from host Debian to docker container"
bin/fixowns "$1"
bin/fixperms "$1"
