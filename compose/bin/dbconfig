#!/usr/bin/env bash

### Configuration de la base de données importée

echo "Importation des données app/etc/config.php et app/etc/env.php en BDD"
bin/magento app:config:import

# URLs des boutiques
echo "Running bin/setup-domain-dn"
bin/setup-domain-dn

# Configuration pour pouvoir accéder aux autres boutiques que FR
echo "Configuration de la base importée pour l'environnement du développeur"
bin/clinotty bin/magento config:set web/url/redirect_to_base 0 --scope="default" > /dev/null

# Configuration pour que Elasticsearch 8 d’Amasty parle avec le serveur Elasticsearch de Docker
# les informations dans app/etc/env.php ne sont pas récupérées ...
bin/magento config:set catalog/search/elasticsearch7_server_hostname elasticsearch
bin/magento config:set amasty_elastic/connection/server_hostname elasticsearch

echo "Exécuter les mises à jour de modules du code source présent sur la base de données importée"
bin/clinotty bin/magento setup:upgrade

# théoriquement ce process consulte la BDD mais je n’ai pas prouvé son utilité pour Ludilabel
#bin/clinotty bin/magento setup:di:compile

echo "Clearing the cache to apply updates..."
bin/clinotty bin/magento cache:flush
