#!/usr/bin/env bash
set -o errexit

# Arguments :
# $1 : DN (Optionnel) nom de domaine pour les URLs des boutiques

source env/setup/magento-stores.env
source env/dev-setup-config.env
source bin/terminal-colors

# listes de données dans env/magento-stores.env
# boutiques Magento 2
declare -A store_codes
for entry in ${TLD_STORE_MAP}; do
  store_codes[${entry%%:*}]=${entry##*:}
done

if [ "$1" ]; then
  DN="$1"
else
    if [ "$DN" ]; then
        echo "Le nom de domaine est déjà configuré : $(yellow "$DN")"
    else
      echo "Veuillez saisir le nom de domaine pour accéder aux boutiques Magento 2 localement"
      read -r -p "(ex : franz.docker.ludilabel) SANS le suffixe du domaine de premier niveau (.fr,...) : " DN
    fi
fi

if [ "$DN" ]; then
  if [ "$1" ]; then
    sed -i "s|^DN=.*|DN=\"$DN\"|" env/dev-setup-config.env
  fi
else
    echo "Ajout de la variable DN à la fin du fichier env/dev-setup-config.env."
    echo "DN=\"$DN\"" >> env/dev-setup-config.env
fi


# scope stores
echo "Ajout des noms de domaine pour toutes les boutiques dans core_config_data"
for TLD in "${!store_codes[@]}"; do
  bin/clinotty bin/magento config:set web/unsecure/base_url "https://$DN.$TLD/" --scope=stores --scope-code="${store_codes[$TLD]}" > /dev/null
done

# scope default
bin/clinotty bin/magento config:set web/unsecure/base_url "https://$DN.fr/" --scope=default  > /dev/null
