#!/usr/bin/env bash
# set -x

source bin/terminal-colors

if [ "$1" ]; then
  WIN_HOST="$1"
else
  echo "Entrée par défaut"
  echo "Sinon coller le chemin Windows complet du fichier hosts"
  read -r -p "(par défaut : C:\Windows\System32\drivers\etc\hosts) : " WIN_HOST
  WIN_HOST=${WIN_HOST:-"C:\\Windows\\System32\\drivers\\etc\\hosts"}
fi

# Transformation du chemin Windows en chemin Debian WSL2
if [[ "$WIN_HOST" =~ ^[A-Za-z]:\\ ]]; then

    # Remplacer les antislashs par des slashes pour la conversion avec wslpath
    WIN_HOST=$(echo "$WIN_HOST" | sed 's|\\|/|g')

    # Convertir le chemin au format WSL
    WIN_HOST=$(wslpath -a "$WIN_HOST")

    if [ $? -ne 0 ]; then
        echo "Erreur lors de la conversion du chemin."
        exit 1
    fi

fi

# Get the local IP address from Windows + strip return line
local_ip=$(powershell.exe -Command "(Get-NetIPAddress -AddressFamily IPv4 | Where-Object { \$_.InterfaceAlias -like '*Ethernet*' -and \$_.IPAddress -match '^192\.168\.' }).IPAddress" | tr -d '\r\n')

# Entries to add to hosts file
# va permettre entre autre à XDebug de communiquer avec l'IDE PHPStorm sur Windows (conf xdebug : client_host -> host.docker.internal)
entries_to_add=(
    "$local_ip host.docker.internal"
    "$local_ip gateway.docker.internal"
)

# Check and remove entries that already exist in the hosts file
for i in "${!entries_to_add[@]}"; do
    entry="${entries_to_add[$i]}"

    # Check if the entry already exists in the hosts file
    if grep -qF "$entry" "$WIN_HOST"; then
        echo "Entry '$entry' already exists in the hosts file."
        unset 'entries_to_add[i]'
    fi
done

if [ ${#entries_to_add[@]} -gt 0 ]; then
    echo "Nous avons analysé votre fichier hosts"
    echo "Il manque les entrées suivantes, copier-coller les dans $WIN_HOST en mode administrateur."

    # Affichage de la liste dans la console pour être copiée
    echo
        for entry in "${entries_to_add[@]}"; do
            yellow "$entry"
        done

    read -p "Continuer l'exécution du script"
else
    echo "Toutes les entrées existent déjà dans le fichier hosts."
fi