#!/usr/bin/env bash
set -o errexit

source env/dev-setup-config.env
source bin/setup-ssh-fn
source bin/wsl-fn

import_prompt_sql() {

  echo "Veuillez coller un chemin Windows de fichier de sauvegarde SQL"
  read -r -p "(ex : D:\projets\magento\import\recette_dump.sql) : " win_bdd_file_path

  wsl_win_bdd_file_path=$(convertWinPathToWslPath "$win_bdd_file_path")

  # Vérifier si le fichier existe
  if [ ! -f "$wsl_win_bdd_file_path" ]; then
      echo "Le fichier spécifié n'existe pas."
      exit 1
  fi

  FILENAME=$(basename "$wsl_win_bdd_file_path")

  echo "Téléchargement du fichier backup sur la Debian"
  rsync -av "$wsl_win_bdd_file_path" "$TRANSFER_PATH/db"

  echo "Importation de la base dans le service Docker (long...)"
  bin/clinotty mysql -h db -u root -pmagento -e "DROP DATABASE IF EXISTS magento; CREATE DATABASE magento;"
  bin/clinotty mysql -h db -u root -pmagento magento < "$TRANSFER_PATH/db/$FILENAME"
}

import_param_sql() {
  local sql_file="$1"

  wsl_sql_file=$(convertWinPathToWslPath "$sql_file")

  # Vérifier si le fichier existe
  if [ ! -f "$wsl_sql_file" ]; then
      echo "Le fichier spécifié n'existe pas."
      exit 1
  fi

  FILENAME=$(basename "$wsl_sql_file")

  echo "Téléchargement du fichier backup sur la Debian"
  rsync -av "$wsl_sql_file" "$TRANSFER_PATH/db"

  echo "Importation de la base dans le service Docker (long...)"

  bin/clinotty mysql -h db -u root -pmagento -e "DROP DATABASE IF EXISTS magento; CREATE DATABASE magento;"
  bin/clinotty mysql -h db -u root -pmagento magento < "$TRANSFER_PATH/db/$FILENAME"
}

import_recette() {

  DATE=$(date +"%Y%m%d_%H%M%S")
  DUMP_FILE="db_backup_recette_$DATE.sql"
  LOCAL_DIR="$TRANSFER_PATH/db"

  # bin/setup-ssh-fn
  run_ssh_agent_and_register_key "$RECETTE_DEBIAN_RSA_PATH"

  # Generate mysqldump on remote server
  ssh "$RECETTE_USER@$RECETTE_IP" "mysqldump -u $RECETTE_DB_USER -p'$RECETTE_DB_PASS' $RECETTE_DB_NAME > /tmp/$DUMP_FILE"

  # Download the dump file to local directory
  echo "Téléchargement du fichier backup sur la Debian"
  scp "$RECETTE_USER@$RECETTE_IP:/tmp/$DUMP_FILE" "$LOCAL_DIR/"

  # Clean up: Remove the dump file from the remote server
  ssh "$RECETTE_USER@$RECETTE_IP" "rm /tmp/$DUMP_FILE"

  echo "Importation de la base dans le service Docker (long...)"
  bin/clinotty mysql -h db -u root -pmagento -e "DROP DATABASE IF EXISTS magento; CREATE DATABASE magento;"
  bin/clinotty mysql -h db -u root -pmagento magento < "$LOCAL_DIR/$DUMP_FILE"
}