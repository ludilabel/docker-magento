#!/usr/bin/env bash

source env/dev-setup-config.env
source bin/setup-ssh-fn

### bin/setup-ssh-fn - permet d’utiliser les commandes Git sans paramètres ssh
run_ssh_agent_and_register_key "id_ed25519"

DOCKER_SERVICE="phpfpm"
CONTAINER_ID=$(bin/docker-compose ps -q $DOCKER_SERVICE | awk '{print $1}')

echo -e "Attention \nTous les fichiers actuellement déployés sur le serveur seront perdus (sources Magento 2, /pub/media, /vendor/, /generated, etc.)"
read -p "Souhaitez-vous vraiment continuer ? (oui/non) : " reponse

# Vérifier la réponse de l'utilisateur
if [[ "$reponse" != "oui" ]]; then
    echo "Annulation de la commande."
    exit 1
fi

TRANSFER_GITHUB_PATH="$TRANSFER_PATH/github"
rm -rf "$TRANSFER_GITHUB_PATH"
mkdir -p "$TRANSFER_GITHUB_PATH"
HOST_SRC=$(cd -P "$TRANSFER_GITHUB_PATH" && pwd)

# on change de dossier courant pour toutes les commandes git qui suivent
cd "$HOST_SRC"

echo "git clone first from Github to Debian"
rm -rf "$HOST_SRC/*"
git clone --no-checkout git@github.com:ludilabel/magento-2.git .
# nécessaire pour que les références vers les branches distantes soient configurées
git fetch --all

if [ "$1" ]; then
  echo "git checkout branch: $1"
  git checkout "$1"
else
  echo "git checkout master"
  git checkout master
fi

echo "Copy from Debian to docker container (< 2mn)"
docker exec "$CONTAINER_ID" rm -rf /var/www/html/*
docker cp "$HOST_SRC/./" "$CONTAINER_ID":/var/www/html/
echo "Completed copying all files from Debian host to container"

# on rétablit le chemin pour lancer les commandes bin/*
cd "$COMPOSE_PATH"

# Toutes les commandes à jouer lorsqu'on change les fichiers sources
echo "Exécution de toutes les commandes bin/* qui sont nécessaires après un changement des fichiers sources"
bin/composer install
bin/fixowns
bin/fixperms
bin/clinotty bin/magento setup:upgrade
bin/magento setup:di:compile
echo "Toutes les commandes bin/* ont été exécutées."

