#!/usr/bin/env bash
set -o errexit

[ -z "$1" ] && echo "Please specify a directory or file to copy from container (ex. vendor)" && exit

source env/dev-setup-config.env

DOCKER_SERVICE="phpfpm"
CONTAINER_ID=$(bin/docker-compose ps -q $DOCKER_SERVICE | awk '{print $1}')

if [ ! -d "$TRANSFER_PATH/from" ]; then
  mkdir -p "$TRANSFER_PATH/from"
fi

HOST_SRC=$(cd -P "$TRANSFER_PATH/from" && pwd)

if bin/clinotty test -f "/var/www/html/$1"; then
  mkdir -p "$HOST_SRC/$(dirname "$1")"
  docker cp "$CONTAINER_ID":/var/www/html/"$1" "$HOST_SRC/$1"
  mkdir -p "$OS_SRC/$(dirname "$1")"
  rsync -az --info=progress2 --delete --exclude='.git' --exclude='.idea' "$HOST_SRC/$1" "$OS_SRC/$(dirname "$1")/"
else
  mkdir -p "$HOST_SRC/$(dirname "$1")"
  docker cp "$CONTAINER_ID":/var/www/html/"$1" "$HOST_SRC/$(dirname "$1")"
  mkdir -p "$OS_SRC/$(dirname "$1")"
  rsync -az --info=progress2 --delete --exclude='.git' --exclude='.idea' "$HOST_SRC/$1/" "$OS_SRC/$1/"
fi

if [ $? -eq 0 ]; then
  echo "Completed copying from container to host"
  echo "Completed copying $1 from Debian to Windows"
  else
    echo "Failed to copy directories/files"
fi
