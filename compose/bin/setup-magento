#!/usr/bin/env bash
set -o errexit
# Enable debugging
# set -x

bin/composer remove elasticsearch/elasticsearch
bin/composer require elasticsearch/elasticsearch:"~7.17.0"

# depend de bin/setup-magento-env
echo "Running, Magento setup:install..."
bin/setup-install

bin/composer require elasticsearch/elasticsearch:"^8.6"

# durant le bin/setup-install, Magento exige que le moteur de recherche soit un officiel : elasticsearch7
# mais ensuite nous avons besoin de le redéfinir en celui d’Amasty pour que le moteur de recherche fonctionne car tout le reste de la configuration
# utilise sur la surcharge d’Amasty
bin/magento config:set catalog/search/engine amasty_elastic_8

echo "Re-indexing with Elasticsearch..."
bin/clinotty bin/magento indexer:reindex

echo "Clearing the cache to apply updates..."
bin/clinotty bin/magento cache:flush

echo "Installing cron, run 'bin/cron start' to enable..."
bin/clinotty bin/magento cron:install

echo "Turning on developer mode..."
bin/clinotty bin/magento deploy:mode:set developer

echo "Après le redémarage qui va suivre, vous pourrez accéder aux urls https:// des boutiques"

# Restart nginx to apply the updates
echo "Restarting containers to apply updates..."
read -p "/// Appuyer sur entrée pour lancer le redémarrage des conteneurs"
bin/restart