#!/usr/bin/env bash
set -o errexit

echo "Running bin/setup-magento-env"
bin/setup-magento-env

# depend de bin/setup-magento-env
#echo "Running, Magento setup:install..."
# en erreur : fonctionnement à comprendre par rapport à app:config:import
# possiblement facultatif comme on a déjà app/etc/config.php et app/etc/env.php correctement personnalisés
#bin/setup-install

echo "Importation des données app/etc/config.php et app/etc/env.php en BDD"
bin/magento app:config:import

echo "Running bin/setup-domain..."
bin/setup-domain

echo "Adding Magento modules to Composer allow-plugins directive..."
bin/clinotty composer config --no-plugins allow-plugins.magento/magento-composer-installer true
bin/clinotty composer config --no-plugins allow-plugins.magento/inventory-composer-installer true
bin/clinotty composer config --no-plugins allow-plugins.laminas/laminas-dependency-plugin true

echo "Re-indexing with Elasticsearch..."
bin/clinotty bin/magento indexer:reindex

echo "Clearing the cache to apply updates..."
bin/clinotty bin/magento cache:flush

echo "Installing cron, run 'bin/cron start' to enable..."
bin/clinotty bin/magento cron:install

echo "Turning on developer mode..."
bin/clinotty bin/magento deploy:mode:set developer

echo "Après le redémarage, vous pouvez accéder aux boutiques depuis votre navigateur"

# Restart nginx to apply the updates
echo "Restarting containers to apply updates..."
read -p "Appuyer sur entrée pour lancer le redémarrage des conteneurs"
bin/restart