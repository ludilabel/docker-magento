#!/usr/bin/env bash
set -o errexit
# dépend de bin/setup-domain-dn

# Arguments :
# $1 : (Optionnel) WIN_HOST : chemin complet Windows du fichier hosts

source env/dev-setup-config.env
source env/setup/magento-stores.env
source bin/terminal-colors
source bin/wsl-fn


# listes de données dans env/magento-stores.env
# boutiques Magento 2
declare -A store_codes
for entry in ${TLD_STORE_MAP}; do
  store_codes[${entry%%:*}]=${entry##*:}
done

if [ "$1" ]; then
  WIN_HOST="$1"
else
    if [ "$OS_HOSTS" ]; then
        echo "Le chemin windows du fichier hosts est déjà configuré : $(yellow "$OS_HOSTS")"
        wsl_win_host="$OS_HOSTS"
    else
        echo "Coller le chemin Windows complet du fichier hosts"
        read -r -p "(Entrée pour la valeur par défaut : C:\Windows\System32\drivers\etc\hosts) : " WIN_HOST
        WIN_HOST=${WIN_HOST:-"C:\\Windows\\System32\\drivers\\etc\\hosts"}
    fi
fi

if [[ ! "$OS_HOSTS" || "$1" ]]; then
   wsl_win_host=$(convertWinPathToWslPath "$WIN_HOST")
  else
   wsl_win_host="$WIN_HOST"
fi

# Vérifier si le fichier existe
if [ ! -f "$wsl_win_host" ]; then
    echo "Le fichier spécifié n'existe pas."
    exit 1
fi

if [ "$OS_HOSTS" ]; then
  if [ "$1" ]; then
    sed -i "s|^OS_HOSTS=.*|OS_HOSTS=\"$OS_HOSTS\"|" env/dev-setup-config.env
  fi
else
    echo "Ajout de la variable OS_HOSTS à la fin du fichier env/dev-setup-config.env."
    echo "OS_HOSTS=\"$wsl_win_host\"" >> env/dev-setup-config.env
fi

DEBIAN_IP=$(hostname -I | awk '{print $1}')

# Initialize an array to hold entries that need to be added
entries_to_add=()
ALL_FQDN=()

# Loop through each top-level domain and prepare the corresponding entry
for TLD in "${!store_codes[@]}"; do
    # Define the entry for each TLD
    entry="$DEBIAN_IP $DN.$TLD"

    ALL_FQDN+=("$DN.$TLD")

    # Check if the entry already exists in the hosts file
    if ! grep -q "$entry" "$wsl_win_host"; then
        echo "Preparing to add entry $entry to the Windows hosts file..."
        entries_to_add+=("$entry")
    else
        echo "Entry $entry already exists in the hosts file."
    fi
done

# If there are entries to add, make a list for the user to copy it
if [ ${#entries_to_add[@]} -gt 0 ]; then
    echo "Nous avons analysé votre fichier hosts"
    echo "Il manque les entrées suivantes, copier/coller les dans $WIN_HOST en mode administrateur."

    # Affichage de la liste dans la console pour être copiée
    echo
        for entry in "${entries_to_add[@]}"; do
            yellow "$entry"
        done

    read -p "Continuer l'exécution du script"

else
    echo "Toutes les entrées existent déjà dans le fichier hosts."
fi

# Pour permettre une communication entre les conteneurs Docker et le Windows du développeur (IDE, etc.)
bin/setup-host-docker-win "$wsl_win_host"