#!/usr/bin/env bash
set -o errexit
# depend on bin/setup-environnement

# Enable debugging
# set -x

source bin/terminal-colors

# Variable globale pour les scripts d'importation base de données et fichiers sources, qui sont prévus pour être joués seuls, n’executent pas des commandes
# comme bin/magento setup:upgrade qui ont besoin que les deux soient déjà installé, ce qui n’est pas le cas pendant le processus initial d'installation
USAGE_MODE="install"
export USAGE_MODE

echo "$(green "Running bin/setup-win-sources...")"
bin/setup-win-sources

echo "$(green "Running bin/setup-recette...")"
bin/setup-recette

# Démarrage pour la première fois des conteneurs Docker
# dépend de bin/setup-win-sources
echo "$(green "Running bin/autostart-containers...")"
bin/autostart-containers

# dépend de bin/setup-recette
echo "$(green "Running bin/import-db...")"
bin/import-db

echo "$(green "Running bin/install-magento-sources... ")"
bin/install-magento-sources

source "$(dirname "$0")/after-import-sources-inc"
source "$(dirname "$0")/after-import-db-config-inc"

# Commandes post-traitement à la main ici car sinon exécutées deux fois avec les scripts "after-*"
bin/fixowns
bin/fixperms

bin/clinotty bin/magento setup:upgrade
bin/clinotty bin/magento setup:di:compile
echo "$(green "Running bin/import-media... (long)")"
bin/import-media

bin/clinotty bin/magento cache:flush

echo "Si certaines valeurs que vous avez données sont incorrectes et empêchent un service de fonctionner"
echo "utiliser la commande bin/debug pour essayer d’y remédier"
